<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Room v1</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #1a1212; overflow: hidden; }
  canvas { display: block; }
  #loading {
    position: fixed; inset: 0; background: #fff;
    z-index: 10; transition: opacity 1.2s ease;
  }
  #loading.fade { opacity: 0; pointer-events: none; }
  #overlay {
    position: fixed; inset: 0;
    display: flex; align-items: center; justify-content: center;
    background: rgba(0,0,0,0.55); z-index: 5; cursor: pointer;
  }
  #overlay.hidden { display: none; }
  #overlay-box {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.18);
    padding: 36px 56px; text-align: center; color: #fff;
    font: 13px/2.2 system-ui, sans-serif;
    backdrop-filter: blur(10px); border-radius: 6px;
  }
  #overlay-box h2 { font-size: 20px; font-weight: 400; margin-bottom: 6px; letter-spacing: 0.03em; }
  #overlay-box p  { opacity: 0.5; font-size: 11px; letter-spacing: 0.06em; text-transform: uppercase; }
  #crosshair {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none; display: none;
  }
  #crosshair::before, #crosshair::after {
    content: ''; position: absolute; background: rgba(255,255,255,0.75);
  }
  #crosshair::before { width: 14px; height: 1px; top: 0; left: -7px; }
  #crosshair::after  { width: 1px; height: 14px; top: -7px; left: 0; }
</style>
</head>
<body>

<div id="loading"></div>
<div id="overlay">
  <div id="overlay-box">
    <h2>Click to explore</h2>
    <p>WASD · move &nbsp;|&nbsp; Mouse · look &nbsp;|&nbsp; E / Q · up / down &nbsp;|&nbsp; ESC · exit</p>
  </div>
</div>
<div id="crosshair"></div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

// ─── Renderer ────────────────────────────────────────────────────────────────
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
document.body.appendChild(renderer.domElement);

// ─── Scene ───────────────────────────────────────────────────────────────────
const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf5efe6);

// ─── Camera ──────────────────────────────────────────────────────────────────
const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.001, 300);

// ─── FPS Controls ────────────────────────────────────────────────────────────
const controls = new PointerLockControls(camera, document.body);
scene.add(controls.getObject());

const overlay   = document.getElementById('overlay');
const crosshair = document.getElementById('crosshair');

overlay.addEventListener('click', () => controls.lock());

controls.addEventListener('lock', () => {
  overlay.classList.add('hidden');
  crosshair.style.display = 'block';
});
controls.addEventListener('unlock', () => {
  overlay.classList.remove('hidden');
  crosshair.style.display = 'none';
});

// ─── WASD ────────────────────────────────────────────────────────────────────
const keys = {};
window.addEventListener('keydown', e => { keys[e.code] = true; });
window.addEventListener('keyup',   e => { keys[e.code] = false; });

function updateMovement(dt) {
  if (!controls.isLocked) return;
  const speed = 1.8 * dt;
  if (keys['KeyW'] || keys['ArrowUp'])    controls.moveForward(speed);
  if (keys['KeyS'] || keys['ArrowDown'])  controls.moveForward(-speed);
  if (keys['KeyA'] || keys['ArrowLeft'])  controls.moveRight(-speed);
  if (keys['KeyD'] || keys['ArrowRight']) controls.moveRight(speed);
  if (keys['KeyE'] || keys['Space'])      camera.position.y += speed;
  if (keys['KeyQ'] || keys['ShiftLeft'])  camera.position.y -= speed;
}

// ─── Load GLB ────────────────────────────────────────────────────────────────
const loading = document.getElementById('loading');

new GLTFLoader().load('room_segmented.glb', (gltf) => {
  const root = gltf.scene;
  const box  = new THREE.Box3().setFromObject(root);
  const center = box.getCenter(new THREE.Vector3());
  const size   = box.getSize(new THREE.Vector3());
  root.position.sub(center);

  // Start inside, roughly at eye height
  camera.position.set(0, size.y * 0.05, 0);

  root.traverse((child) => {
    if (!(child instanceof THREE.Mesh)) return;

    // MeshBasicMaterial — vertex colors only, no lighting = no distant blackout
    child.material = new THREE.MeshBasicMaterial({
      vertexColors: true,
      side: THREE.DoubleSide,
    });

    // Thin wireframe edge overlay
    const edges = new THREE.EdgesGeometry(child.geometry, 15);
    child.add(new THREE.LineSegments(edges, new THREE.LineBasicMaterial({
      color: 0x2a2520, transparent: true, opacity: 0.35, depthTest: true,
    })));
  });

  scene.add(root);
  loading.classList.add('fade');
  setTimeout(() => loading.style.display = 'none', 1300);
});

// ─── Resize ──────────────────────────────────────────────────────────────────
window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

// ─── Render loop ─────────────────────────────────────────────────────────────
let last = performance.now();
function animate() {
  requestAnimationFrame(animate);
  const now = performance.now();
  const dt  = Math.min((now - last) / 1000, 0.05);
  last = now;
  updateMovement(dt);
  renderer.render(scene, camera);
}

animate();
</script>
</body>
</html>
